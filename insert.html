<script>

    (function(){
        var component_ID = {
            type: "tab",
            beta: true,
            version: 1.0,
            kind: "component",
            name: "insert.html",
            path: "/product-tab/insert.html",
            description: "creates new product in zangoDB.",
        };
    })();

</script>

<script>

(function(){

    const VERSION = 1;
    const NAME = "PRODUCTS";

    PRODUCTS = new zango.Db( NAME, {
        products:    true,
        snapshots:   true,
        connectors:  true,
    });

    PRODUCTS.open(function(err, database){
        if (err) console.error(err);
    }).then( function(){
        debugMode && console.log(`Database ${PRODUCTS.name} (v${PRODUCTS.version}) opened.`);
    }).catch(function(err){
        console.error(err);
    });

})();

</script>

<script>
/*
(function(){

//  const VERSION = 6;
    const NAME = "USER";

    USER = new zango.Db( NAME, {
        current:    true,
        settings:   true,
        animations: true,
        outfits:    true,
        materials:  true,
        textures:   true,
    });

    USER.open(function(err, database){
        if (err) console.error(err);
    }).then( function(){
        debugMode && console.log(`Database ${USER.name} (v${USER.version}) opened.`);
    }).catch(function(err){
        console.error(err);
    });

})();
*/
</script>

<style>

    h4.x-large {
        height:35px;
    }

    .selected {
        box-shadow: inset 0 1px 1px rgba(0,0,0,.075), 0 0 8px rgba(0, 142, 255, 1);
    }

    .product-title-field {
        color:#ffffff;
        background:none;
    }

    .product-item-value {
        text-align: center;
        font-size: x-large;
        font-weight: bold;
    }
    
    .product-item-textfield {
        width:70%;
        float:right;
    }

    .x-large {
        font-size: x-large;
    }

    .snapshot-item {
        width:85px;
        height:85px;
        margin:4px;
        background-size: contain;
        background-position:50% 50%;
        background-repeat:no-repeat;
    }

/*  collection pager  */

    .helpers-header h3 { cursor:pointer; }

    .collection-item {
        padding: 4px 15px;
        text-align: left;
        vertical-align: middle;
        cursor: pointer;
    }

    .selected {
        color:#fff;
        background-color:#73b8f3;
    }

    #collection-items-panel {
        max-width:475px;
    /*  max-height:710px; */
        color:#fff;
        border:none;
        padding:0px;
        background-color:#fff0;
    }

    #documents-display {
        height:170px;
        overflow:auto;
        background:none;
        border-radius:8px;
    }

    .page-btn {
        max-width:45px;
        padding:6px 10px;
    }

</style>

<div class="helpers-header newitem-header" style="margin-bottom:20px;">
    <input type="text" id="product-title" class="form-control text-center x-large product-title-field" placeholder="untitled product">
</div>

<div id="product-preview-panel" style="margin-bottom:20px;">

    <div style="text-align:center;margin-bottom:10px;border:1px solid;">
        <img id="product-preview" style="max-width:100%;max-height:300px;margin:auto;">
        <script>
            (function(){
                const productPreview = $("img#product-preview").get(0);
                $(productPreview).on("load", function(){
                    if ( this.src.startsWith("blob:") ) {
                        window.URL.revokeObjectURL(this.src); // important!
                        debugMode && console.log("revoked", this.src);
                    }
                });
            })();
        </script>
    </div>

    <div style="margin-bottom:10px;">
        <input type="file" id="image-file-input" accept="image/*" class="hidden" multiple>
        <div id="image-import-button" class="form-control btn btn-success btn-white-outline gradient-btn" style="width:32%;">Import</div>
        <div id="image-upload-button" class="form-control btn btn-success btn-white-outline gradient-btn" style="width:33%;">Upload</div>
        <div id="image-remove-button" class="form-control btn btn-danger btn-white-outline gradient-btn" style="width:32%;float:right;">Remove</div>
    </div>

</div>

<div class="helpers-header product-snapshots-header" style="margin-bottom:20px;">

    <h3>Snapshots:</h3>

    <div class="product-snapshots-container" style="margin-bottom:0px;overflow-y:hidden;max-width:300px;">
        <div id="product-snapshots" class="product-snapshots" style="display:inline-block;width:max-content;">
            <!-- li class="btn btn-default btn-white-outline snapshot-item product-snapshot-item"></li -->
        </div>
    </div>

    <div style="text-align:center;margin-bottom:10px;">
        <div id="snapshot-add-button" class="form-control btn btn-info btn-white-outline gradient-btn" style="width:fit-content;float:left;">Add</div>
        <div id="snapshot-master-button" class="form-control btn btn-primary btn-white-outline gradient-btn" style="width:fit-content;">Set main</div>
        <div id="snapshot-upload-button" class="form-control btn btn-success btn-white-outline gradient-btn" style="width:fit-content;">Upload</div>
        <div id="snapshot-remove-button" class="form-control btn btn-danger btn-white-outline gradient-btn" style="width:fit-content;float:right;">Remove</div>
    </div>

</div>

<div id="product-basic-info-panel" style="margin-bottom:20px;">

    <div id="product-outfit-container" style="display:none;">

        <h4 class="x-large">Sex:
            <div class="product-item-textfield" style="display:inline-block;">
                <select id="product-gender" class="form-control gender-droplist product-gender-droplist" readOnly>
                    <option value="">Select gender:</option>
                    <option value="male">male</option>
                    <option value="female">female</option>
                </select>
            </div>
        </h4>

        <h4 class="x-large">Slot:
            <div class="product-item-textfield" style="display:inline-block;">
                <select id="product-outfit" class="form-control slot-droplist product-outfit-droplist" readOnly>
                    <option value="">Select slot:</option>
                    <option value="body">body</option>
                    <option value="eyes">eyes</option>
                    <option value="hairs">hairs</option>
                    <option value="stockings">stockings</option>
                    <option value="underwears">underwears</option>
                    <option value="costume">costume</option>
                    <option value="tshirt">tshirt</option>
                    <option value="trousers">trousers</option>
                    <option value="dress">dress</option>
                    <option value="shoes">shoes</option>
                </select>
            </div>
        </h4>

    </div>

    <div id="product-collection-container">
        <h4 class="x-large">Kind:
            <div class="product-item-textfield" style="display:inline-block;">
                <select id="product-collection" class="form-control product-collection-droplist" readOnly>
                    <option value="">Select collection:</option>
                    <option value="outfits">outfit</option>
                    <option value="textures">texture</option>
                    <option value="materials">material</option>
                    <option value="animations">animation</option>
                </select>
            </div>
        </h4>
    </div>

</div>

<div id="collection-panel" class="tab-content" style="display:none;">

    <div id="collection-items-panel" class="well">

        <hr />

        <h4>Choose item:
            <div id="counter" class="pull-right small" style="margin-top:4px;color:#ddd;">
                <span id="from">zero</span>
                to <span id="upto">zero</span>
                of <span id="count">none</span>
            </div>
        </h4>

        <div id="collection-pager" class="pager">
            <div style="margin:10px 0px 10px;height:35px;">
                <li class="btn btn-primary get-prev-btn pull-left">&#9668;</li>
                <div class="pager-buttons-holder" style="display:inline;">
                    <a class="btn btn-default page-btn">1</a>
                    <a class="btn btn-default page-btn">2</a>
                    <a class="btn btn-default page-btn">3</a>
                    <a class="btn btn-default page-btn">4</a>
                </div>
                <li class="btn btn-primary get-next-btn pull-right">&#9658;</li>
            </div>

            <div id="documents-display" class="well"></div>

            <div style="margin:10px 0px 10px;height:35px;">
                <li class="btn btn-primary btn-white-outline first-page-btn pull-left" style="margin-right:5px;">First</li>
                <li class="btn btn-primary btn-white-outline get-prev-group-btn pull-left">&#9668;&#9668;</li>
                <li class="btn btn-primary btn-white-outline last-page-btn pull-right" style="margin-left:5px;">Last</li>
                <li class="btn btn-primary btn-white-outline get-next-group-btn pull-right">&#9658;&#9658;</li>
            </div>
        </div>

    </div>

</div>

<script>

$(viewer.contentWindow).on("load", function(){

    const contentWindow = this;

//  const viewer = document.getElementById("viewer");
    const genderDroplist = $("#product-gender").get(0);

    var Signal = signals.Signal;
    var genderDroplistChanged = new Signal();

    $(genderDroplist).on("change", function(){

        if ( !this.value ) {

        //  Overwrite gender value.
            this.value = contentWindow.localPlayer.outfit.getGender();

        }

    //  Null values NOT allowed.

        if ( !this.value ) return;

        genderDroplistChanged.dispatch( this.value );

    });

    genderDroplistChanged.add(function(value){

    //  Null values NOT allowed.

        if ( !value ) return;

        var data = "/gender/" + value;
        contentWindow.localPlayerHandler(data);

        store( "Sex", data );

    });

});

</script>

<script>

$(viewer.contentWindow).on("load", function(){

    const contentWindow = this;

//  const viewer = document.getElementById("viewer");
    const collectionPanel = document.getElementById("collection-panel");
    const collectionDroplist = document.getElementById("product-collection");

    var Signal = signals.Signal;
    var collectionDroplistChanged = new Signal();

    $(collectionDroplist).on("change", function(){

        if ( !this.value ) {
            $(collectionPanel).slideUp();
        } else {
            $(collectionPanel).slideDown();
        }

        collectionDroplistChanged.dispatch(this.value);

    });

    collectionDroplistChanged.add(function(value){

        if (!value) return;

        switch (value) {

            case "outfits":

            break;

            case "textures":

            break;

            case "materials":

            break;

            case "animations":

            break;

        }

    });

});

</script>

<input type="text" id="product-value" class="form-control product-item-value" style="margin-bottom:10px;" placeholder="Price">

<div id="product-description-panel" class="well" style="height:250px;margin-bottom:20px;background:none;">
    <h4 style="margin-top:0px;">Description:</h4>
    <textarea id="product-description" style="width:100%;height:180px;overflow:auto;border:none;background:none;"></textarea>
</div>

<div style="margin-bottom:10px;">

    <div>
        <h4 class="x-large">Status:
            <div class="product-item-textfield" style="display:inline-block;">
                <select id="product-state" class="form-control helper" readOnly>
                    <option value="">on hold</option>
                    <option value="1">publish</option>
                </select>
            </div>
        </h4>
    </div>

    <div>
        <h4 class="x-large">Owner:
            <input type="text" id="product-owner" class="form-control product-item-textfield" disabled placeholder="User name">
        </h4>
    </div>

</div>

<div style="margin-bottom:10px;">
    <div id="product-test-button" class="form-control btn btn-info btn-white-outline gradient-btn" style="width:28%;float:left;">Test</div>
    <div id="product-save-button" class="form-control btn btn-success btn-white-outline gradient-btn" style="width:40%;margin:0 2%">Save</div>
    <div id="product-cancel-button" class="form-control btn btn-danger btn-white-outline gradient-btn" style="width:28%;float:right;">Cancel</div>
</div>

<script>

$(viewer.contentWindow).on("load", function(){

    const contentWindow = this;

//  const viewer = document.getElementById("viewer");
    const genderDroplist = document.getElementById("product-gender");
    const outfitDroplist = document.getElementById("product-outfit");
    const collectionDroplist = document.getElementById("product-collection");

    const outfitDroplistContainer = document.getElementById("product-outfit-container");
    const collectionDroplistContainer = document.getElementById("product-collection-container");

    const productTitle = document.getElementById("product-title");
    const productState = document.getElementById("product-state");
    const productValue = document.getElementById("product-value");
    const productDescription = document.getElementById("product-description");

    const NoSrc = "//:0";
    const noimage = "/img/no-image-avaliable-200x200.png";
    const LoremIpsum = "Sed ac metus fermentum nisi lacinia sodales. "
    + "Nullam porta tristique justo et laoreet. Vestibulum pulvinar, "
    + "purus a finibus commodo, quam lectus imperdiet arcu, "
    + "vel sollicitudin augue ligula quis lorem. "
    + "Nunc vehicula lectus nec quam interdum, vitae mattis sapien iaculis. "
    + "Duis et dui sed lorem hendrerit sollicitudin. "
    + "Donec ut justo tincidunt, finibus nisi ut, fringilla augue. "
    + "Donec a nibh nec libero pellentesque semper et vel lacus. Integer quis magna quam";

    const snapshotItemSelector = ".snapshot-item.product-snapshot-item";

    const productPreviewPanel = document.getElementById("product-preview-panel");
    const productPreviewImage = $(productPreviewPanel).find("img#product-preview").get(0);
    const imagePreviewInput   = $(productPreviewPanel).find("#image-file-input").get(0);
    const imageImportButton   = $(productPreviewPanel).find("#image-import-button").get(0);
    const imageUploadButton   = $(productPreviewPanel).find("#image-upload-button").get(0);
    const imageRemoveButton   = $(productPreviewPanel).find("#image-remove-button").get(0);

    productPreviewImage.src = noimage;
    productDescription.value = LoremIpsum;

    const productSnapshots = document.getElementById("product-snapshots");
    const snapshotAddButton = document.getElementById("snapshot-add-button");
    const snapshotMasterButton = document.getElementById("snapshot-master-button");
    const snapshotUploadButton = document.getElementById("snapshot-upload-button");
    const snapshotRemoveButton = document.getElementById("snapshot-remove-button");

    const testProductButton = document.getElementById("product-test-button");
    const saveProductButton = document.getElementById("product-save-button");
    const cancelProductButton = document.getElementById("product-cancel-button");

    var masterSnapshot;
    var selectedSnapshot;
    var snapshotFiles = {};

    var Signal = signals.Signal;
    var productFormChanged = new Signal();
    var snapshotFileImported = new Signal();
    var addSnapshotBtnClicked = new Signal();
    var removeSelectedSnapshot = new Signal();
    var productSaveButtonClicked = new Signal();
    var outfitProductDroplistUpdate = new Signal();

    //  Every change in product form,
    //  creates an fresh "entry" on-fly.

    productFormChanged.add(function(){

        var gender = contentWindow.localPlayer.outfit.getGender();
        var kind = $(collectionDroplist).val();            // kind.
        var title = $(productTitle).val();               // name.
        var value = round( $(productValue).val(), 2);    // price.
        var outfit = $(outfitDroplist).val();            // slot.
        var publish = Boolean( $(productState).val() );  // boolean.
        var description = $(productDescription).val();   // text.

    //  Set main snapshot (preview).
        var previewSelector = snapshotItemSelector + ".preview";
        if ( $(previewSelector).get(0) == undefined ) {
            if (masterSnapshot) $(masterSnapshot).addClass("preview");     // important!
            else $( $(snapshotItemSelector).get(0) ).addClass("preview");  // important!
        }

        var preview = $(previewSelector).get(0);
        debugMode && console.dir( preview );

        var slength = $(snapshotItemSelector).length;
        debugMode && console.log( "snapshots:", $(snapshotItemSelector) );

        var entry = {
            _id: ObjectId(),
            uuid: generateUUID(),
        };

        if (kind) entry.kind = kind;
        if (title) entry.name = title;
        if (value) entry.price = value;
        if (gender) entry.gender = gender;
        if (outfit) entry.outfit = outfit;
        if (preview) entry.preview = preview;
        if (description) entry.description = description;
        if (slength) entry.snapshots = $(snapshotItemSelector).toArray(); // [elements].

        entry.publish = publish;

    //  Entry does not contain any outfit reference.
    //  We use a pair of {product.uuid, outfit.uuid},
    //  to connect the product with the outfit and
    //  deliver the data to the customer.

        debugMode && console.log(entry);

    });

   $(genderDroplist).on("change", function(){
        if ( !this.value ) return;
        productFormChanged.dispatch();
    });

    $(outfitDroplist).on("change", function(){
        if ( !this.value ) return;
        productFormChanged.dispatch();
    });

    $(collectionDroplist).on("change", function(){
        if ( !this.value ) return;
        productFormChanged.dispatch();
    });

    $(productTitle).on("change", function(){
        if ( !this.value ) return;
        productFormChanged.dispatch();
    });

    $(productState).on("change", function(){
        if ( !this.value ) return;
        productFormChanged.dispatch();
    });

    $(productValue).on("change", function(){
        if ( !this.value ) return;
        productFormChanged.dispatch();
    });

    $(productDescription).on("change", function(){
        if ( !this.value ) return;
        productFormChanged.dispatch();
    });


    $(collectionDroplist).on("change", function(){

        if (this.value) {
            outfitProductDroplistUpdate.dispatch();
            $(outfitDroplistContainer).slideDown();
        } else {
            $(outfitDroplistContainer).slideUp();
            $(outfitDroplist).children().remove();
        }

    });

    outfitProductDroplistUpdate.add( function (){

        $(outfitDroplist).children().remove();

        var option = document.createElement("option");
        option.value = "";  option.innerText = "Select slot:";
        $(outfitDroplist).append(option);

        if ( !contentWindow ) return;
        if ( !contentWindow.localPlayer ) return;
        if ( !contentWindow.localPlayer.outfit ) return;

        var slots = [];
        var gender = contentWindow.localPlayer.outfit.getGender();
        for (var key in contentWindow[ gender ] ) {
            if ( contentWindow[ gender ][ key ].parent ) slots.push( key ); // filter (danger!).
        }

        debugMode && console.log({"slots":slots});

        slots.forEach(function(slot){
            if (slot == "gender") return;
            var option = document.createElement("option");
            option.value = option.innerText = slot;
            $(outfitDroplist).append(option);
        });

        $(outfitDroplist).val("");

    });

//  SNAPSHOTS.

    var snapCounter = 0;     // snapshots counter.

    $(imageImportButton).on("click", function(){
        $(imagePreviewInput).val("");
        $(imagePreviewInput).click();
    });

    $(imagePreviewInput).on("change", function(){
        snapshotFileImported.dispatch(this.files);
    });

    $(imageRemoveButton).on("click", function(){
        removeSelectedSnapshot.dispatch();
    });

    $(snapshotAddButton).on("click", function(){
        addSnapshotBtnClicked.dispatch();
    });

    $(snapshotRemoveButton).on("click", function(){
        removeSelectedSnapshot.dispatch();
    });

    $(snapshotMasterButton).on("click", function(){
        $(snapshotItemSelector).removeClass("preview");

        if (!selectedSnapshot) {
            masterSnapshot = null;
        } else {
            masterSnapshot = selectedSnapshot;
            $(masterSnapshot).addClass("preview");
        }

        debugMode && console.dir(masterSnapshot);
    });


//  BUTTON UPLOAD.

    $(imageUploadButton).on("click", uploadSelectedSnapshot);
    $(snapshotUploadButton).on("click", uploadSelectedSnapshot);

    function uploadSelectedSnapshot(){

        if ( !navigator.onLine ) {
            var err = "Your connection to the internet is down.";
            debugMode && console.error(err);
            return bootbox.dialog( errorDialogOptions(err) );
        }

        var snapshot = $(snapshotItemSelector + ".selected").get(0);

        if ( !snapshot ) {
            var err = `None selected snapshot found!`;
            return bootbox.dialog( errorDialogOptions(err) );
        }

        if (snapshot.uploaded) {
            var msg = `Snapshot has been already uploaded.`;
            return userNotificationDialogMessage(msg);
        }

        debugMode && console.dir(snapshot); 

        var name = snapshot.name;
        var type = "image/jpeg";
        var data = snapshot.data.replace("data:image/jpeg;base64,", ""); // important!

        var dialog = bootbox.dialog({
            message: `<div class="text-center meter">`
            + `<span style="width:100%;">Uploading...`
            + `</span></div>`,
            buttons: false,
            closeButton: false,
            className: "middle",
        });

        caches.open("products").then(function(cache){

            new Promise(function(resolve, reject){

            //  Disable upload button.
                $(imageUploadButton).off(); // important!
                $(snapshotUploadButton).off(); // important!
                debugMode && console.log(`uploading ${name}...`);

                var formdata = new FormData();
                formdata.append("image", data);
                formdata.append("type",  type);
                formdata.append("name",  name);
                formdata.append("title", name);

                var xhttp = new XMLHttpRequest();
                var clientid = "1812ad6d78faf36";  // product app Client-ID.
                var endpoint = "https://api.imgur.com/3/image";
                xhttp.open("POST", endpoint, true);
                xhttp.setRequestHeader("Authorization", "Client-ID " + clientid);
                xhttp.onreadystatechange = function () {
                    if (this.readyState === 4) {
                        var response = "";
                        if (this.status >= 200 && this.status < 300) {
                            response = JSON.parse(this.responseText);
                            resolve( response ); // resolve promise.
                        } else {
                            var err = JSON.parse(this.responseText).data.error;
                            console.error( err.type, err );
                            throw err;
                        }
                    }
                };

                xhttp.send(formdata);
                xhttp = null;

            }).then( function( response ){

                var data = response.data;
                debugMode && console.log({"data": data});

                snapshot.data = null;      // important!
                snapshot.id = data.id;     // important!
                snapshot.link = data.link; // important!
                snapshot.uploaded = true;  // important!

                snapshot.clientID = "1812ad6d78faf36";// product app Client-ID.
                snapshot.endpoint = "https://api.imgur.com/3/image/" + data.id;         // important!
                snapshot.delpoint = "https://api.imgur.com/3/image/" + data.deletehash; // important!
                snapshot.thumbnail = data.link.replace(data.id, data.id + "s");

                return data;

            }).then( function( data ){

            //  Add to collection.

                var entry = {};

                entry._id = data.id;
                entry.url = data.link;
                entry.size = data.size;
                entry.type = data.type;
                entry.name = data.name || data.title;
                entry.width = data.width;
                entry.height = data.height;
                entry.datetime = data.datetime;
                entry.deletehash = data.deletehash;
                entry.thumbnail = data.link.replace(data.id, data.id + "s");
                entry.clientID = "1812ad6d78faf36";// product app Client-ID.
                entry.endpoint = "https://api.imgur.com/3/image/" + data.id;

                debugMode && console.log({"entry":entry});

            //  Add to collection.

                var collection = PRODUCTS.collection("snapshots");

                collection.insert(entry, function(err){
                    if (err) throw err;
                }).catch(function(err){
                    console.error(err);
                });

                return data;

            }).then( function( data ){

            //  Add to cache.
                return cache.add( data.link ).then(function(){
                    return caches.open("thumbnails").then(function(thumbnails){
                        return thumbnails.add( data.link.replace(data.id, data.id + "s") )
                        .then(function(){ return data.link; });
                    });
                });

            }).then( function( url ){

            //  Preview snapshot.
                cache.match( url ).then(function(response){
                    return response.blob();
                }).then(function(blob){
                    productPreviewImage.src = window.URL.createObjectURL(blob);
                });

            }).then( function(){

                productFormChanged.dispatch(); // testing!

            }).catch(function(err){

                bootbox.hideAll();
                console.error(err);
                bootbox.dialog( errorDialogOptions(err) );

            }).then(function(){

                dialog.modal("hide"); // important!
            //  Enable upload button. // important!
                $(imageUploadButton).on("click", uploadSelectedSnapshot );
                $(snapshotUploadButton).on("click", uploadSelectedSnapshot );
                debugMode && console.log( "Upload button is enabled and ready to upload." );

            });

        });

    }

    snapshotFileImported.add(function(files){

        if ( files.length == 0 ) return;

        for (var i = 0; i < files.length; i++ ) {

            ++snapCounter;    // snapshots counter.

            (function(){

                var file = files[i];
                var name = files[i].name;
                snapshotFiles[ name ] = file;

                var reader = new FileReader();
                reader.onload = function() {

                    productPreviewImage.src = reader.result;

                //  DOMElement.

                    var snapshot = document.createElement("li");
                    snapshot.name = name;
                    snapshot.file = file;
                    snapshot.data = reader.result; 
                    snapshot.classList.add(
                        "btn", "btn-default", "btn-white-outline", 
                        "snapshot-item", "product-snapshot-item"
                    );

                //  Thumbnails.

                    var img = new Image(85, 85);
                    var canvas = document.createElement("canvas");
                    var ctx = canvas.getContext("2d");
                    canvas.width = img.width;
                    canvas.height = img.height;
                    $(img).one("load", function(){

                        ctx.drawImage( img, 0, 0, img.width, img.height );

                        var url = canvas.toDataURL("image/jpeg", 0.5);
                        snapshot.style["background-image"] = `url(${url})`;

                        snapshot.style["background-size"] = "contain";
                        snapshot.style["background-repeat"] = "no-repeat";
                        snapshot.style["background-position"] = "50% 50%";

                        $(img).remove();

                    }).attr({src: reader.result});

                    var selector = snapshotItemSelector;     // important!

                    $(snapshot).on("click", function(){

                        $(selector).removeClass("selected");
                        $(snapshot).addClass("selected");         // this.

                        selectedSnapshot = snapshot;              // this.

                        if ( snapshot.data ) {

                            productPreviewImage.src = snapshot.data;

                        } else if (snapshot.link && snapshot.endpoint && snapshot.delpoint) {

                            caches.open("products").then(function(cache){
                                cache.match( snapshot.link ).then(function(response){
                                    return response.blob();
                                }).then(function(blob){
                                    productPreviewImage.src = window.URL.createObjectURL(blob);
                                });
                            });

                        } else {

                            productPreviewImage.src = noimage;

                        }



                        debugMode && console.dir(selectedSnapshot);

                    });

                //  Set last as selected snapshot.
                    $(selector).removeClass("selected");
                    $(snapshot).addClass("selected");
                    selectedSnapshot = snapshot;

                //  Set as main the first snapshot.
                    if (!masterSnapshot) {
                        $(selector).removeClass("preview");
                        $(snapshot).addClass("preview");
                        masterSnapshot = snapshot;
                    }

                    debugMode && console.dir(snapshot);
                    $(productSnapshots).append(snapshot);

                };

                reader.readAsDataURL(snapshotFiles[ name ]);

            })();

        }

    });

    addSnapshotBtnClicked.add(function(){

    //  Direct call scene window (dont use socket).
    //  Returns a resolved promise with snapshot dataULR.

        ++snapCounter; // snapshot counter.

        var cmd = "/product/crop";
        contentWindow.sceneHandler(cmd).then(function(data){

        //  debugMode && console.log(data);
        //  productPreviewImage.src = data;

        //  DOMElement.

            var snapshot = document.createElement("li");
            snapshot.data = productPreviewImage.src = data; 
            snapshot.name = `product snapshot ${snapCounter}.jpg`;
            snapshot.classList.add(
                "btn", "btn-default", "btn-white-outline", 
                "snapshot-item", "product-snapshot-item"
            );

        //  Thumbnails.

            (function(){

                var img = new Image(85, 85);
                var canvas = document.createElement("canvas");
                var ctx = canvas.getContext("2d");
                canvas.width = img.width;
                canvas.height = img.height;
                $(img).one("load", function(){

                    ctx.drawImage( img, 0, 0, img.width, img.height );

                    var url = canvas.toDataURL("image/jpeg", 0.5);
                    snapshot.style["background-image"] = `url(${url})`;

                    snapshot.style["background-size"] = "contain";
                    snapshot.style["background-repeat"] = "no-repeat";
                    snapshot.style["background-position"] = "50% 50%";

                    $(img).remove();

                }).attr({src: data});

            })();

            var selector = snapshotItemSelector;     // important!

            $(snapshot).on("click", function(){

                $(selector).removeClass("selected");
                $(snapshot).addClass("selected");

                selectedSnapshot = snapshot;

                if (snapshot.data) {

                    productPreviewImage.src = snapshot.data;

                } else if (snapshot.link && snapshot.endpoint && snapshot.delpoint) {

                    caches.open("products").then(function(cache){
                        cache.match( snapshot.link ).then(function(response){
                            return response.blob();
                        }).then(function(blob){
                            productPreviewImage.src = window.URL.createObjectURL(blob);
                        });
                    });

                } else {

                    productPreviewImage.src = noimage;

                }

                debugMode && console.dir(selectedSnapshot);

            });

        //  Set as selected snapshot.
            $(selector).removeClass("selected");
            $(snapshot).addClass("selected");
            selectedSnapshot = snapshot;

        //  Set as main the first snapshot.
            if (!masterSnapshot) {
                $(selector).removeClass("preview");
                $(snapshot).addClass("preview");
                masterSnapshot = snapshot;
            }

            debugMode && console.dir(snapshot);
            $(productSnapshots).append(snapshot);

        }).catch(function(err){
            console.error(err);
        });

    });

    removeSelectedSnapshot.add(function(){

        if ( !selectedSnapshot ) return;

        var name = selectedSnapshot.name;
        delete snapshotFiles[ name ];

        $(selectedSnapshot).remove();

        if (selectedSnapshot == masterSnapshot) {
            masterSnapshot = undefined;
        }

        selectedSnapshot = undefined;

        productPreviewImage.src = noimage;
        debugMode && console.log(snapshotFiles);
        debugMode && console.dir(masterSnapshot);
        debugMode && productFormChanged.dispatch();

    });


    $(testProductButton).on("click", function(){
        productFormChanged.dispatch();
    });

    function resetProductForm(){

        $(productTitle).val("");             // name.
        $(productValue).val("");             // price.
        $(productState).val("");             // publish.
        $(genderDroplist).val("");           // gender.
        $(outfitDroplist).val("");           // slot.
        $(snapshotItemSelector).remove();    // snapshots.
        $(productDescription).val(LoremIpsum);  // description.
        $(collectionDroplist).val("").change(); // collection.

        masterSnapshot = null;               // preview.
        productPreviewImage.src = noimage;   // preview.
        $(productSnapshots).children().remove(); // snapshots.

    }

    $(saveProductButton).on( "click", validateProductForm );

    function validateProductForm(){

    //  VALIDATIONS.

        if ( !contentWindow.localPlayer.outfit.getGender() ) {

            var msg = "You don't have gender selected.<br>"
            + "Please select a product gender and try again.";
            return bootbox.dialog( cancelDialogOptions(msg) );

        }

        if ( !collectionDroplist.value ) {

            var msg = "You don't have any kind selected.<br>"
            + "Please select a product kind and try again.";
            return bootbox.dialog( cancelDialogOptions(msg) );

        }

        if ( !outfitDroplist.value ) {

            var msg = "You don't have any outfit slot selected.<br>"
                    + "Please select an outfit slot and try again.";
            return bootbox.dialog( cancelDialogOptions(msg) );

        }

        if ( !productTitle.value ) {

            var msg = "Please type a title for <br>"
                    + "this product and try again:";
            var title = `<div class="alert-icon icon-warning">`
                + `</div><h4 style="margin:auto;">${msg}</h4>`;
            var defaultValue = "untitled product";

            return bootbox.prompt({

                title: title,
                size: "small",
                className: "middle",
                value: defaultValue,
                closeButton: false,
                callback: callback,

            });

            function callback(result){
                var msg = `Save canceled.`;
                var err = `Name is required. Save canceled.`;
                debugMode && console.log({"result":result});

                if ( result == defaultValue ) {

                    $(saveProductButton).click();

                } else if ( result == null ) {
                    userNotificationDialogMessage(msg);

                } else if ( result.length == 0 ) {
                    userNotificationDialogMessage(err);

                } else {

                    productTitle.value = result;

                }
            }

        }

    //  SNAPSHOTS.

        var snapshots = [];                      // [ imgur ids ].

        $(snapshotItemSelector).toArray().forEach(function(item){
            if (item.id) snapshots.push( item.id );
        });

        if ( snapshots.length == 0 ) {

            var msg = "You don't have any snapshots uploaded.<br>"
            + "Please upload at least one snapshot and try again.";
            return bootbox.dialog( cancelDialogOptions(msg) );

        }

        if ( !masterSnapshot ) {

            var msg = "You don't have define any snapshot as main.<br>"
            + "Please define a snapshot as main preview and try again.";
            return bootbox.dialog( cancelDialogOptions(msg) );

        }

    //  productFormChanged.dispatch();
        productSaveButtonClicked.dispatch();

    }

    productSaveButtonClicked.add(function(){

        var kind = $(collectionDroplist).val();          // kind.
        var title = $(productTitle).val();               // name.
        var value = round( $(productValue).val(), 2);    // price.
        var gender = contentWindow.localPlayer.outfit.getGender();
        var outfit = $(outfitDroplist).val();            // slot.
        var preview = masterSnapshot.id;                 // imgur id.
        var publish = Boolean( $(productState).val() );  // boolean.
        var description = $(productDescription).val();   // text.

        if (!kind) return;
        if (!title) return;
        if (!gender) return;
        if (!outfit) return;
        if (!preview) return;

    //  SNAPSHOTS.

        var uploads = [];
        var snapshots = [];                      // [ imgur ids ].

        $(snapshotItemSelector).toArray().forEach(function(item){
            if (item.id) snapshots.push( item.id );
        });

        if (!snapshots.length) return;

    //  Disable save button.
        $(saveProductButton).off();  // important!

    //    if (kind) entry.kind = kind;
    //    if (title) entry.name = title;
    //    if (value) entry.price = value;
    //    if (outfit) entry.slot = outfit;    // slot.
    //    if (gender) entry.gender = gender;
    //    if (preview) entry.preview = preview;
    //    if (snapshots.length) entry.snapshots = snapshots;
    //    entry.publish = publish;

        var entry = {
            _id: ObjectId(),
            demo: true,
            kind: kind,
            name: title,
            slot: outfit,
            gender: gender,
            preview: preview,
            publish: publish,
            snapshots: snapshots,
            uuid: generateUUID(),
        };

        if (description) entry.description = description;

        debugMode && console.log(entry);

    //  To connect a product with an outfit we  
    //  use a pair of {productUUID, itemUUID}.

        var itemUUID = generateUUID(); // demo!
        var productUUID = entry.uuid;

    //  Then we use a separate collection to 
    //  keep this pair of UUIDs. When we want 
    //  to get the item of the product, we go
    //  to that collection with the productUUID,
    //  we get the itemUUID, and then we search,
    //  the item to deliver.

        var connector = {
            _id: ObjectId(),
            demo: true,
            database: "USER",
            collection: kind,
            itemUUID: itemUUID,
            productUUID: productUUID,
        };

        Promise.all([

            PRODUCTS.collection("products")
            .insert(entry, function(err){
                if (err) throw err;
            }).catch(function(err){
                console.error(err);
            }),

            PRODUCTS.collection("connectors")
            .insert(connector, function(err){
                if (err) throw err;
            }).catch(function(err){
                console.error(err);
            }),

        ]).then(function(){

            var msg = `Product ${title} saved!`;
            userNotificationDialogMessage( msg );

            debugMode && console.log({
                "entry":entry,
                "connector":connector,
            });

        }).catch(function(err){
            debugMode && console.error(err);
            bootbox.dialog( errorDialogOptions(err) );

        }).then(function(){

        //  Reset form.
            resetProductForm();

        //  Enable save button.
            $(saveProductButton).on( "click", validateProductForm ); // important!

        });

    });

    contentWindow.localPlayer.outfit.changed.add(function(){
        outfitProductDroplistUpdate.dispatch();
    });

});

</script>


